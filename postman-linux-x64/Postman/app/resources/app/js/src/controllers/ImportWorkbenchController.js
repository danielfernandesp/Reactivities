"use strict";(self.webpackChunk_postman_app_renderer=self.webpackChunk_postman_app_renderer||[]).push([[184],{"../../packages/api-design/import/src/controllers/ImportWorkbenchController.js":function(e,t,i){i.r(t),i.d(t,{default:function(){return C}});var o,s,n,l,r,a=i("../../node_modules/mobx/lib/mobx.module.js"),p=i("../../node_modules/lodash/lodash.js"),d=i.n(p),c=i("./appsdk/workbench/BaseWorkbenchController.js"),m=i("./js/services/NavigationService.js"),u=i("./api-dev/services/APIDevService.js"),I=i("./js/stores/ActiveWorkspaceStore.js"),E=i("./js/stores/StoreManager.js"),A=i("./js/stores/TabUIStore.js"),h=i("../../packages/api-design/schema-editor/index.js"),g=i("../../packages/api-design/import/src/utils/NewrelicHelper.js"),v=i("../../packages/api-design/api-design-analytics/index.js"),f=i("../../packages/api-design/import/src/utils/ImportHelper.js"),y=i("../../packages/api-design/import/src/utils/FeatureFlags.js"),b=i("../../packages/api-design/import/src/utils/ImportOptionsHelper.js");function T(e,t,i,o){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(o):void 0})}function P(e,t,i,o,s){var n={};return Object.keys(o).forEach((function(e){n[e]=o[e]})),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=i.slice().reverse().reduce((function(i,o){return o(e,t,i)||i}),n),s&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(s):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(e,t,n),n=null),n}const _=["COLLECTION","COLLECTION_V2","COLLECTION_V2_1","COLLECTION_V2_CLOUDAPI"];let C=(o=class extends c.default{constructor(...e){super(...e),this.files=[],T(this,"isProcessingComplete",s,this),T(this,"shouldCloseTab",n,this),T(this,"areAPIElementsAdded",l,this),T(this,"areAllElementsImported",r,this),this.importElementEvents=[],this.importedAPIElements=[],this.importedNonAPIElements=[]}_setAllElementsImportFlag(e){this.areAllElementsImported=e}_setAPIElemetsAddedFlag(e){this.areAPIElementsAdded=e}_setFiles(e){this.files=e,this.isProcessingComplete=!0}_setImportedAPIElements(e){this.importedAPIElements=e,this._setAPIElemetsAddedFlag(d().get(e,"length",0)>0)}_setImportedNonAPIElements(e){this.importedNonAPIElements=e}isTabActive(){return(0,E.resolveStoreInstance)(A.default).activeTab===this.tabId}closeTab(){this.shouldCloseTab=!0,(0,v.logApiDesignAnalytics)({category:v.EVENT_CATEGORIES.IMPORT,action:v.EVENT_ACTIONS.IMPORT_ENTITIES_TAB_X})}async doImport(e,t,i){var o;i=await(0,b.getConfigurationsForAPIEntity)(i);const s=await(0,f.importNonAPIEntities)(e,!0,!1),n=d().filter(t,(e=>!e.isCollectionGenerationOnly));d().isEmpty(n)||this.subscribeToWorkspaceForAllAPIs();let{apisToImport:l,importedAPIs:r,importedAPICollections:a}=await(0,f.importAPIs)({items:t},{value:"unclassified"},i),p=[],c=[];this.optionsPreferenceForRetry=i,d().forEach(r,((e,t)=>{p.push({apiId:null==e?void 0:e.id,apiVersionId:d().get(e,"versions[0].id"),name:e.name,relationType:"apiDefinition",relationInfo:"Definition",relationName:e.relationName,relationId:e.relationId,status:"processing",originalItem:e.originalItem}),d().includes(h.GENERATE_COLLECTION_DISABLED_FORMATS,d().get(l,`[${t}].format.id`))||p.push({apiId:null==e?void 0:e.id,apiVersionId:d().get(e,"versions[0].id"),name:e.name,relationType:"unclassified",relationName:"Postman Collection v2.1",relationId:"COLLECTION_V2_1",status:"processing",originalItem:e.originalItem})}));const m="NON_API_ELEMENT";d().forEach(a,((e,t)=>{const i=1===d().get(e,"collection.imported",0)?"completed":"failed";c.push({type:m,name:e.name,relationName:"Postman Collection v2.1",relationId:"COLLECTION_V2_1",status:i}),"failed"===i&&this.WSCollectionsForRetry.push(e.originalItem)})),d().forEach(e,((e,t)=>{var i,o,n,l;const r=s[t],a=d().head(d().keys(r.value)),p="fulfilled"===r.status&&d().get(r,["value",a,"imported"])?"completed":"failed";c.push({type:m,name:null==e?void 0:e.name,relationName:null==e||null===(i=e.file)||void 0===i||null===(o=i.format)||void 0===o?void 0:o.name,relationId:null==e||null===(n=e.file)||void 0===n||null===(l=n.format)||void 0===l?void 0:l.id,status:p}),"failed"===p&&this.nonAPIElementsForRetry.push(e)})),this._setImportedAPIElements(p),this._setImportedNonAPIElements(c),this._setAPIElemetsAddedFlag(!0),0===(null===(o=this.importedAPIElements)||void 0===o?void 0:o.length)&&this.checkImportStatus();let u=0,I=0;u+=l.length,I+=r.length,d().forEach(s,(e=>{u+=e.total,I+=e.imported})),u>0&&0===I&&pm.toasts.error("Import failed. Try again.")}didCreate(e){if(this.nonAPIElementsForRetry=[],this.WSCollectionsForRetry=[],this.apisForRetry=[],this.importModalV2Enabled=(0,y.isImportModalV2Enabled)(),this.importModalV2Enabled){let t=d().get(e,"additionalContext.nonAPIEntities"),i=d().get(e,"additionalContext.apiEntities"),o=d().get(e,"additionalContext.optionsPreference");if(this.importAnalytics=d().get(e,"additionalContext.analytics"),d().isEmpty(t)&&d().isEmpty(i))return m.default.transitionTo("build.import",{},{}),void this.closeTab();this._setAllElementsImportFlag(!1),this._setImportedAPIElements(d().reduce(i,((e,t)=>{var i,o;(d().includes(h.GENERATE_COLLECTION_DISABLED_FORMATS,null===(i=t.file)||void 0===i?void 0:i.format.id)||e.push({status:"processing"}),t.isCollectionGenerationOnly)||(e.push({status:"processing"}),d().includes(h.GENERATE_COLLECTION_DISABLED_FORMATS,null===(o=t.file)||void 0===o?void 0:o.format.id)||e.push({status:"processing"}));return e}),[])),this._setAPIElemetsAddedFlag(!1),this._setImportedNonAPIElements(d().forEach(t,(e=>e.status="processing"))),this.doImport(t,i,o)}else{let t=d().get(e,"additionalContext.files");if(d().isEmpty(t))return m.default.transitionTo("build.import",{},{}),void this.closeTab();this._setAllElementsImportFlag(!1),this._setImportedAPIElements([]),this._setImportedNonAPIElements([]),this._setFiles(t)}}subscribeToWorkspaceForAllAPIs(){var e;let t=null===(e=(0,E.resolveStoreInstance)(I.default))||void 0===e?void 0:e.id,i=Date.now();t&&(this.workspaceAPIsSubscription=u.default.getAllAPIRealtimeEvents(t).subscribe((async e=>{var t;let o=null==e?void 0:e.data;"import"!==(null==e||null===(t=e.meta)||void 0===t?void 0:t.action)||"api-import-create-relation"!==(null==o?void 0:o.task)||"apiDefinition"!==(null==o?void 0:o.relationType)&&"unclassified"!==(null==o?void 0:o.relationType)||((0,g.newrelicPageAction)("apiMetrics",{action:"importAPI",event:"api-import-create-relation-"+o.relationType,status:o.status,duration:Date.now()-i}),this.importElementEvents=[...this.importElementEvents,o],await(0,a.when)((()=>this.areAPIElementsAdded)),this.checkImportStatus())}),(e=>pm.logger.warn("Failed to subscribe to workspace for all APIs",e))))}addAnalyticsEvents(){if((0,y.isImportModalV2Enabled)()){this.importedAPIElements.forEach((e=>{var t;"completed"===e.status&&e.apiId&&"apiDefinition"===e.relationType&&!d().includes(h.GENERATE_COLLECTION_DISABLED_FORMATS,e.relationId)&&(0,v.logApiDesignAnalytics)({traceId:null===(t=this.importAnalytics)||void 0===t?void 0:t.traceId,category:v.EVENT_CATEGORIES.IMPORT,action:"collection_import",label:"def_collection",entityId:e.apiId,entityType:"API Definition"})})),this.importedNonAPIElements.forEach((e=>{var t;"completed"===e.status&&(d().includes(_,e.relationId)&&(0,v.logApiDesignAnalytics)({traceId:null===(t=this.importAnalytics)||void 0===t?void 0:t.traceId,category:v.EVENT_CATEGORIES.IMPORT,action:"collection_import",label:"collection"}))}));const e={},t={};[...this.importedAPIElements,...this.importedNonAPIElements].forEach((i=>{if(d().get(e,i.relationId)?e[i.relationId]+=1:e[i.relationId]=1,i.extension)d().get(t,i.extension)?e[i.extension]+=1:e[i.extension]=1;else if("apiDefinition"===i.relationType&&i.originalItem){var o;const e=null===(o=i.originalItem)||void 0===o?void 0:o.file;if(e){var s;const i=null===(s=e.path)||void 0===s?void 0:s.split("."),o=d().isArray(i)&&i.length>1&&i.pop();if(o&&(d().get(t,o)?t[o]++:t[o]=1,e.relatedFiles))for(let i of e.relatedFiles){var n;let e=null==i||null===(n=i.path)||void 0===n?void 0:n.split("."),o=d().isArray(e)&&e.length>1&&e.pop();o&&(d().get(t,o)?t[o]++:t[o]=1)}}}})),d().forOwn(e,((e,t)=>{var i,o,s,n;return(0,v.logApiDesignAnalytics)({traceId:null===(i=this.importAnalytics)||void 0===i?void 0:i.traceId,category:v.EVENT_CATEGORIES.IMPORT,action:`${null===(o=this.importAnalytics)||void 0===o?void 0:o.action}${null!==(s=this.importAnalytics)&&void 0!==s&&s.selectedRepo?`_${null===(n=this.importAnalytics)||void 0===n?void 0:n.selectedRepo}`:""}`,label:`${t}-${e}`})})),d().forOwn(t,((e,t)=>{var i,o,s,n;(0,v.logApiDesignAnalytics)({traceId:null===(i=this.importAnalytics)||void 0===i?void 0:i.traceId,category:v.EVENT_CATEGORIES.IMPORT,action:`${null===(o=this.importAnalytics)||void 0===o?void 0:o.action}${null!==(s=this.importAnalytics)&&void 0!==s&&s.selectedRepo?`_${null===(n=this.importAnalytics)||void 0===n?void 0:n.selectedRepo}`:""}`,label:`${t}#${e}`})}))}}checkImportStatus(){const{failedElementCount:e,processedElementCount:t,totalElementCount:i}=this.getImportElementCount();if(t&&t===i){var o;if(this.addAnalyticsEvents(),this.isTabActive())this.navigateToImportComplete();else if(e===i){const t=1===e?"We weren’t able to import an element. ":"We weren’t able to import any elements. ";pm.toasts.error(t,{title:"Import failed",secondaryAction:{label:"Import Again",onClick:()=>{(0,v.logApiDesignAnalytics)({category:v.EVENT_CATEGORIES.IMPORT,action:"view_toast_status"}),m.default.transitionTo("build.import",{},{})}},onDismiss:()=>{(0,v.logApiDesignAnalytics)({category:v.EVENT_CATEGORIES.IMPORT,action:"toast_close"})},persist:!0,iconName:"icon-state-error-stroke",iconColor:"content-color-error"})}else if(t===i){const t=0===e?"All elements were imported.":`We were unable to import ${e} element${1===e?"":"s"}.`;pm.toasts.success(t,{title:"Import completed",secondaryAction:{label:"View import status",onClick:()=>{(0,v.logApiDesignAnalytics)({category:v.EVENT_CATEGORIES.IMPORT,action:"view_toast_status"}),this.navigateToImportComplete()}},onDismiss:()=>{(0,v.logApiDesignAnalytics)({category:v.EVENT_CATEGORIES.IMPORT,action:"toast_close"})},persist:!0,iconName:"icon-state-success-stroke",iconColor:"content-color-success"})}return(null===(o=this.workspaceAPIsSubscription)||void 0===o?void 0:o.unsubscribe)&&this.workspaceAPIsSubscription.unsubscribe(),this.workspaceAPIsSubscription=null,void this._setAllElementsImportFlag(!0)}}getImportStatusFromEvents(e,t){const i=d().find(this.importElementEvents,(i=>i.id===e&&i.relationType===t));return(null==i?void 0:i.status)||"processing"}getRelationIdFromEvents(e,t){const i=d().find(this.importElementEvents,(i=>i.id===e&&i.relationType===t));return null==i?void 0:i.relationId}getImportElementCount(){var e,t;let i=0,o=0,s=0,n=0,l=0,r=this.importedAPIElements.length+this.importedNonAPIElements.length;return d().forEach(this.importedAPIElements,(e=>{const t=this.getImportStatusFromEvents(e.apiId,e.relationType);"completed"===t?(e.status="completed",i++,l++):"failed"===t&&(e.status="failed",o++,l++,s++,this.apisForRetry&&this.apisForRetry.push(e.originalItem))})),d().forEach(this.importedNonAPIElements,(e=>{"completed"===e.status?(i++,l++):"failed"===e.status&&(o++,l++,n++)})),(0,v.logApiDesignAnalytics)({traceId:null===(e=this.importAnalytics)||void 0===e?void 0:e.traceId,category:v.EVENT_CATEGORIES.IMPORT,action:"import_failed",label:`api_element-${s}`}),(0,v.logApiDesignAnalytics)({traceId:null===(t=this.importAnalytics)||void 0===t?void 0:t.traceId,category:v.EVENT_CATEGORIES.IMPORT,action:"import_failed",label:`nonapi_element-${n}`}),{completedElementCount:i,failedElementCount:o,processedElementCount:l,totalElementCount:r}}navigateToImportComplete(){const e=[...this.WSCollectionsForRetry,...this.apisForRetry],t=this.nonAPIElementsForRetry,i=this.optionsPreferenceForRetry;m.default.transitionTo("build.importEntitiesComplete",{},m.default.getActiveQueryParams().get(),{additionalContext:{importedElements:d().concat(d().map(this.importedAPIElements,(e=>d().assign({},e,{status:this.getImportStatusFromEvents(e.apiId,e.relationType),relationId:this.getRelationIdFromEvents(e.apiId,e.relationType)}))),this.importedNonAPIElements),apiEntities:e,nonAPIEntities:t,optionsPreference:i},tabOptions:{openIn:this.tabId}})}},s=P(o.prototype,"isProcessingComplete",[a.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n=P(o.prototype,"shouldCloseTab",[a.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l=P(o.prototype,"areAPIElementsAdded",[a.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r=P(o.prototype,"areAllElementsImported",[a.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P(o.prototype,"_setAllElementsImportFlag",[a.action],Object.getOwnPropertyDescriptor(o.prototype,"_setAllElementsImportFlag"),o.prototype),P(o.prototype,"_setAPIElemetsAddedFlag",[a.action],Object.getOwnPropertyDescriptor(o.prototype,"_setAPIElemetsAddedFlag"),o.prototype),P(o.prototype,"_setFiles",[a.action],Object.getOwnPropertyDescriptor(o.prototype,"_setFiles"),o.prototype),P(o.prototype,"closeTab",[a.action],Object.getOwnPropertyDescriptor(o.prototype,"closeTab"),o.prototype),o)},"../../packages/api-design/import/src/utils/ImportOptionsHelper.js":function(e,t,i){i.r(t),i.d(t,{getConfigurationsForAPIEntity:function(){return p}});var o=i("./js/services/conversion/formats/openapi3.js"),s=i("./js/services/conversion/formats/raml1.js"),n=i("./js/services/conversion/formats/wsdl2.js"),l=i("./js/services/conversion/formats/graphql.js"),r=i("./js/services/conversion/util.js"),a=i("../../node_modules/lodash/lodash.js");async function p(e){const t={openapi:o.default,raml:s.default,wsdl:n.default,graphql:l.default},i={};for(const o in t){const s=t[o],n=a.filter(await s.getOptions({moduleVersion:(0,r.getConverterVersion)("import")}),"external"),l=a.reduce(n,((e,t)=>(e[t.id]=t.default,e)),{}),p=a.assign({},l,e[o]);p.parametersResolution&&(p.requestParametersResolution=p.parametersResolution,p.exampleParametersResolution=p.parametersResolution),i[o]=p}return i}}}]);